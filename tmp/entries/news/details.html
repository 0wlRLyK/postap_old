{% load static comments hitcount_tags %}
{% load comments_xtd %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Новость {{ news.title }}</title>
</head>
<body>

<h2>{{ news.title }}</h2>
<hr>
<p>{{ news.descript }}</p>
<hr>
Просмотры: <b>{{ news.hit_count.hits }}</b> <br>
{% for foo in some %}
    <img src="/media/{{ foo.image }}" alt="">

{% endfor %}

LIKES <br>
<ul>
    <li data-id="{{ news.id }}" data-type="news" data-action="like" title="Нравится">
        <span class="glyphicon glyphicon-thumbs-up">Like</span>
        <span data-count="like">|{{ news.votes.likes.count }}|</span>
    </li>
    <li data-id="{{ news.id }}" data-type="news" data-action="dislike" title="Не нравится">
        <span class="glyphicon glyphicon-thumbs-down">Dislike</span>
        <span data-count="dislike">|{{ news.votes.dislikes.count }}|</span>
    </li>
</ul>
<br>Likes end <br>


COMMENTS
{% get_comment_count for news as comment_count %}
<div class="py-4 text-center">
    <a href="/news">Back to the post list</a>
    &nbsp;&sdot;&nbsp;
    {{ comment_count }} comment{{ comment_count|pluralize }}
    ha{{ comment_count|pluralize:"s,ve" }} been posted.
</div>

<div class="comment">
    <h4 class="text-center">Your comment</h4>
    <div class="well">
        {% render_comment_form for object %}
    </div>
</div>

{% if comment_count %}
    <ul class="media-list">
        {% render_xtdcomment_tree for news allow_flagging allow_feedback show_feedback %}
    </ul>
{% endif %}
COMMENTS

{% block extra-js %}
    <script
            src="https://code.jquery.com/jquery-3.3.1.min.js"
            crossorigin="anonymous"></script>
    <script
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
            integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
            crossorigin="anonymous"></script>
    <script
            src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
            integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
            crossorigin="anonymous"></script>
    <script>
        // Получение переменной cookie по имени
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Настройка AJAX
        $(function () {
            $.ajaxSetup({
                headers: {"X-CSRFToken": getCookie("csrftoken")}
            });
        });

        $(function () {
            $('[data-toggle="tooltip"]').tooltip({html: true});
        });

        function like() {
            var like = $(this);
            var type = like.data('type');
            var pk = like.data('id');
            var action = like.data('action');
            var dislike = like.next();
            console.log(like);

            $.ajax({
                url: "/likes/" + type + "/" + pk + "/" + action + "/",
                type: 'POST',
                data: {'obj': pk},

                success: function (json) {
                    like.find("[data-count='like']").text(json.like_count);
                    dislike.find("[data-count='dislike']").text(json.dislike_count);
                }
            });

            return false;
        }

        function dislike() {
            var dislike = $(this);
            var type = dislike.data('type');
            var pk = dislike.data('id');
            var action = dislike.data('action');
            var like = dislike.prev();

            $.ajax({
                url: "/likes/" + type + "/" + pk + "/" + action + "/",
                type: 'POST',
                data: {'obj': pk},

                success: function (json) {
                    dislike.find("[data-count='dislike']").text(json.dislike_count);
                    like.find("[data-count='like']").text(json.like_count);
                }
            });

            return false;
        }

        // Подключение обработчиков
        $(function () {
            $('[data-action="like"]').click(like);
            $('[data-action="dislike"]').click(dislike);
        });
    </script>
{% endblock %}
</body>
</html>